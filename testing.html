<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manual Push Notification</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
</head>
<body>
  <h2>Manual Web Push Notification</h2>

  <button id="notifyBtn" disabled>Send Test Notification</button>
  <p>FCM Token (copy to use on other devices):</p>
  <textarea id="tokenArea" rows="4" cols="50" readonly></textarea>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDptVEqHvZqOF1deQrOpnhQI_w6Vb5n4zQ",
      authDomain: "watersystem-e444e.firebaseapp.com",
      databaseURL: "https://watersystem-e444e-default-rtdb.firebaseio.com",
      projectId: "watersystem-e444e",
      storageBucket: "watersystem-e444e.firebasestorage.app",
      messagingSenderId: "528910169669",
      appId: "1:528910169669:web:05c99d2ca2e6d8c069952c",
      measurementId: "G-H05MNY69J6"
    };

    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();
    const notifyBtn = document.getElementById('notifyBtn');
    const tokenArea = document.getElementById('tokenArea');
    let fcmToken = '';

    // 1️⃣ Register service worker first
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('firebase-messaging-sw.js')
        .then(registration => {
          console.log('Service Worker registered');
          messaging.useServiceWorker(registration);

          // 2️⃣ Request notification permission
          return Notification.requestPermission();
        })
        .then(permission => {
          if(permission !== 'granted') {
            alert("Notifications blocked by user!");
            return;
          }

          // 3️⃣ Get FCM token
          return messaging.getToken({
            vapidKey: 'BI9HCoP2mTvQuI24ZMbEWNhPJk4xoFumvhT7qaecz1gfprTTyIjWgPZqO_Zw4jh06f1iDD3JqkHnD9uxkVxDEGE'
          });
        })
        .then(token => {
          if(!token) {
            console.error("FCM token not generated!");
            return;
          }
          fcmToken = token;
          tokenArea.value = fcmToken;
          notifyBtn.disabled = false; // enable button
          console.log("FCM Token:", token);
        })
        .catch(err => console.error("Error setting up FCM:", err));
    }

    // 4️⃣ Send test notification locally
    notifyBtn.addEventListener('click', () => {
      if(!fcmToken) {
        alert("FCM token not ready yet!");
        return;
      }

      new Notification("Test Notification", {
        body: "This notification is sent manually!",
        icon: "https://firebase.google.com/favicon.ico"
      });
    });
  </script>
</body>
</html>
